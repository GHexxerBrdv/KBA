<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIP-4337 Account Abstraction Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <!-- Link CSS file -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="connection-status" id="connectionStatus">
        üî¥ Disconnected
    </div>

    <div class="container">
        <div class="header">
            <h1>‚ö° Smart Account Platform</h1>
            <p>Create and manage EIP-4337 Account Abstraction wallets</p>
            <p class="subtitle">Deploy ‚Ä¢ Fund ‚Ä¢ Execute ‚Ä¢ Interact with any contract</p>
        </div>

        <div class="main-content">
            <!-- Connect Wallet Card -->
            <div class="card">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M21 18v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v1" />
                        <path d="M21 9H3" />
                        <path d="M21 15H3" />
                    </svg>
                    Wallet Connection
                </h2>
                <div id="walletInfo" class="wallet-info" style="display: none;">
                    <h3>üîó Connected Wallet</h3>
                    <div class="info-row">
                        <span class="info-label">Address:</span>
                        <span class="info-value" id="walletAddress"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Network:</span>
                        <span class="info-value" id="networkName"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Balance:</span>
                        <span class="info-value"><span id="walletBalance"></span> ETH</span>
                    </div>
                </div>
                <button id="connectWallet" class="btn">ü¶ä Connect MetaMask</button>
                <div id="walletStatus" class="status"></div>

                <div class="feature-highlight">
                    <h4>üöÄ Getting Started</h4>
                    <p>Connect your MetaMask wallet to begin creating and managing smart contract accounts. Make sure
                        you're on a supported network with some ETH for gas fees.</p>
                </div>
            </div>

            <!-- Create Account Card -->
            <div class="card" id="createAccountCard">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="m22 21-3-3m0 0-3-3 3 3 3-3-3 3Z" />
                    </svg>
                    Deploy Smart Account
                </h2>
                <div class="form-group">
                    <label for="entryPointAddress">EntryPoint Contract Address</label>
                    <input type="text" id="entryPointAddress" placeholder="0x..."
                        value="0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789">
                </div>
                <button id="deployAccount" class="btn" disabled>üöÄ Deploy Minimal Account</button>
                <div id="accountStatus" class="status"></div>
                <div id="accountInfo" style="display: none;">
                    <h3>‚úÖ Your Smart Account</h3>
                    <div class="info-row">
                        <span class="info-label">Account Address:</span>
                        <span class="info-value" id="accountAddress"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Owner:</span>
                        <span class="info-value" id="accountOwner"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">EntryPoint:</span>
                        <span class="info-value" id="accountEntryPoint"></span>
                    </div>
                </div>
            </div>

            <!-- Fund Account Card -->
            <div class="card" id="fundAccountCard">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                    </svg>
                    Fund Smart Account
                </h2>
                <div class="form-group">
                    <label for="fundAmount">Amount to Fund (ETH)</label>
                    <input type="number" id="fundAmount" placeholder="0.01" step="0.001" value="0.01">
                </div>
                <button id="fundAccount" class="btn btn-secondary" disabled>üí∞ Fund Account</button>
                <div id="fundStatus" class="status"></div>

                <div class="warning">
                    ‚ö†Ô∏è Your smart account needs ETH to execute transactions. Fund it before trying to execute any
                    operations.
                </div>
            </div>

            <!-- Simple Transaction Card -->
            <div class="card" id="simpleTransactionCard">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M7 17L17 7M17 7H7M17 7V17" />
                    </svg>
                    Simple Transaction
                </h2>
                <div class="form-group">
                    <label for="simpleDestAddress">Destination Address</label>
                    <input type="text" id="simpleDestAddress" placeholder="0x...">
                </div>
                <div class="form-group">
                    <label for="simpleEthValue">ETH Amount</label>
                    <input type="number" id="simpleEthValue" placeholder="0.001" step="0.001">
                </div>
                <button id="executeSimpleTransaction" class="btn" disabled>üì§ Send ETH</button>
                <div id="simpleTransactionStatus" class="status"></div>
            </div>

            <!-- Advanced Contract Interaction Card -->
            <div class="card full-width contract-interaction" id="contractInteractionCard">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path
                            d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                    </svg>
                    Advanced Contract Interaction
                </h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="contractAddress">Contract Address</label>
                        <input type="text" id="contractAddress" placeholder="0x...">
                    </div>
                    <div class="form-group">
                        <label for="contractValue">ETH Value (if payable)</label>
                        <input type="number" id="contractValue" placeholder="0" step="0.001">
                    </div>
                </div>

                <div class="function-builder">
                    <h3 style="color: #10b981; margin-bottom: 15px;">üîß Function Builder</h3>
                    <div class="form-group">
                        <label for="functionName">Function Name</label>
                        <input type="text" id="functionName" placeholder="e.g., transfer, approve, mint">
                    </div>

                    <div id="functionInputs">
                        <div class="input-group">
                            <div class="form-group" style="margin: 0; flex: 1;">
                                <label>Parameter Type</label>
                                <select class="param-type">
                                    <option value="address">address</option>
                                    <option value="uint256">uint256</option>
                                    <option value="string">string</option>
                                    <option value="bool">bool</option>
                                    <option value="bytes">bytes</option>
                                    <option value="uint8">uint8</option>
                                    <option value="uint32">uint32</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0; flex: 2;">
                                <label>Parameter Value</label>
                                <input type="text" class="param-value" placeholder="Enter value...">
                            </div>
                            <button type="button" class="remove-btn" style="display: none;">‚úï</button>
                        </div>
                    </div>

                    <button type="button" class="add-btn">+ Add Parameter</button>

                    <div class="form-group" style="margin-top: 20px;">
                        <label for="manualCalldata">Or Enter Manual Calldata (Advanced)</label>
                        <textarea id="manualCalldata" rows="3"
                            placeholder="0x... (leave empty to use function builder)"></textarea>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <button id="encodeFunction" class="btn btn-secondary">üî® Encode Function</button>
                    <button id="executeContractCall" class="btn" disabled>üöÄ Execute Contract Call</button>
                </div>

                <div id="encodedCalldata" style="display: none;">
                    <h4 style="color: #fbbf24; margin: 15px 0 10px 0;">Encoded Calldata:</h4>
                    <div class="address" id="calldataResult"></div>
                </div>

                <div id="contractInteractionStatus" class="status"></div>

                <div class="feature-highlight">
                    <h4>üéØ Contract Interaction Guide</h4>
                    <p><strong>Function Builder:</strong> Enter the function name and parameters to automatically encode
                        the call.</p>
                    <p><strong>Manual Calldata:</strong> For advanced users who want to provide pre-encoded function
                        data.</p>
                    <p><strong>Examples:</strong> transfer(address,uint256), approve(address,uint256),
                        mint(address,uint256)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Link JavaScript file -->
    <script>
        // Global variables
        let provider;
        let signer;
        let userAddress;
        let smartAccountAddress;
        let isConnected = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            updateConnectionStatus();
            setupEventListeners();
            checkWalletConnection();
            updateRemoveButtons();
        });

        // Setup all event listeners
        function setupEventListeners() {
            // Wallet connection
            document.getElementById('connectWallet').addEventListener('click', connectWallet);

            // Account operations
            document.getElementById('deployAccount').addEventListener('click', deploySmartAccount);
            document.getElementById('fundAccount').addEventListener('click', fundSmartAccount);
            document.getElementById('executeSimpleTransaction').addEventListener('click', executeSimpleTransaction);

            // Contract interaction
            document.getElementById('encodeFunction').addEventListener('click', encodeFunction);
            document.getElementById('executeContractCall').addEventListener('click', executeContractCall);

            // Function builder
            document.querySelector('.add-btn').addEventListener('click', addParameter);
            document.getElementById('functionInputs').addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-btn')) {
                    removeParameter(e.target);
                }
            });

            // Form validation
            document.getElementById('simpleDestAddress').addEventListener('input', validateSimpleTransaction);
            document.getElementById('simpleEthValue').addEventListener('input', validateSimpleTransaction);
            document.getElementById('contractAddress').addEventListener('input', validateContractInteraction);
        }

        // Check if wallet is already connected
        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet(false);
                    }
                } catch (error) {
                    console.log('No wallet connected');
                }
            }
        }

        // Connect to MetaMask wallet
        async function connectWallet(showStatus = true) {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask is not installed');
                }

                if (showStatus) {
                    showStatusMessage('walletStatus', 'Connecting to MetaMask...', 'info');
                }

                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                // Initialize ethers provider and signer using v6 syntax
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Get network info
                const network = await provider.getNetwork();
                const balance = await provider.getBalance(userAddress);
                const balanceEth = ethers.formatEther(balance);

                // Update UI
                document.getElementById('walletAddress').textContent = formatAddress(userAddress);
                document.getElementById('networkName').textContent = `${network.name} (${network.chainId})`;
                document.getElementById('walletBalance').textContent = parseFloat(balanceEth).toFixed(4);

                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectWallet').textContent = '‚úÖ Connected';
                document.getElementById('connectWallet').classList.add('connected');

                // Enable other cards
                document.getElementById('deployAccount').disabled = false;

                isConnected = true;
                updateConnectionStatus();

                if (showStatus) {
                    showStatusMessage('walletStatus', 'Successfully connected to MetaMask!', 'success');
                }

                // Listen for account changes
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);

            } catch (error) {
                console.error('Connection error:', error);
                showStatusMessage('walletStatus', `Connection failed: ${error.message}`, 'error');
            }
        }

        // Handle account changes
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else if (accounts[0] !== userAddress) {
                location.reload(); // Reload page on account change
            }
        }

        // Handle chain changes
        function handleChainChanged(chainId) {
            location.reload(); // Reload page on chain change
        }

        // Disconnect wallet
        function disconnectWallet() {
            provider = null;
            signer = null;
            userAddress = null;
            smartAccountAddress = null;
            isConnected = false;

            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('connectWallet').textContent = 'ü¶ä Connect MetaMask';
            document.getElementById('connectWallet').classList.remove('connected');

            // Disable buttons
            document.getElementById('deployAccount').disabled = true;
            document.getElementById('fundAccount').disabled = true;
            document.getElementById('executeSimpleTransaction').disabled = true;
            document.getElementById('executeContractCall').disabled = true;

            // Hide account info
            document.getElementById('accountInfo').style.display = 'none';
            document.getElementById('encodedCalldata').style.display = 'none';

            updateConnectionStatus();
        }

        // Deploy smart account (simulated)
        async function deploySmartAccount() {
            try {
                if (!isConnected) {
                    throw new Error('Please connect your wallet first');
                }

                showStatusMessage('accountStatus', 'Deploying smart account...', 'info');

                const entryPointAddress = document.getElementById('entryPointAddress').value;
                if (!ethers.isAddress(entryPointAddress)) {
                    throw new Error('Invalid EntryPoint address');
                }

                // Simulate deployment delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Generate a random address for simulation
                smartAccountAddress = ethers.Wallet.createRandom().address;

                // Update UI
                document.getElementById('accountAddress').textContent = formatAddress(smartAccountAddress);
                document.getElementById('accountOwner').textContent = formatAddress(userAddress);
                document.getElementById('accountEntryPoint').textContent = formatAddress(entryPointAddress);
                document.getElementById('accountInfo').style.display = 'block';

                // Enable other features
                document.getElementById('fundAccount').disabled = false;
                document.getElementById('executeSimpleTransaction').disabled = false;
                document.getElementById('executeContractCall').disabled = false;

                showStatusMessage('accountStatus', 'Smart account deployed successfully!', 'success');

            } catch (error) {
                console.error('Deployment error:', error);
                showStatusMessage('accountStatus', `Deployment failed: ${error.message}`, 'error');
            }
        }

        // Fund smart account (simulated)
        async function fundSmartAccount() {
            try {
                if (!smartAccountAddress) {
                    throw new Error('Please deploy a smart account first');
                }

                const amount = document.getElementById('fundAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('Please enter a valid amount');
                }

                showStatusMessage('fundStatus', 'Sending ETH to smart account...', 'info');

                // Simulate transaction delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                showStatusMessage('fundStatus', `Successfully funded account with ${amount} ETH!`, 'success');

            } catch (error) {
                console.error('Funding error:', error);
                showStatusMessage('fundStatus', `Funding failed: ${error.message}`, 'error');
            }
        }

        // Execute simple transaction (simulated)
        async function executeSimpleTransaction() {
            try {
                if (!smartAccountAddress) {
                    throw new Error('Please deploy a smart account first');
                }

                const destAddress = document.getElementById('simpleDestAddress').value;
                const ethValue = document.getElementById('simpleEthValue').value;

                if (!ethers.isAddress(destAddress)) {
                    throw new Error('Invalid destination address');
                }

                if (!ethValue || parseFloat(ethValue) <= 0) {
                    throw new Error('Please enter a valid ETH amount');
                }

                showStatusMessage('simpleTransactionStatus', 'Executing transaction...', 'info');

                // Simulate transaction delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                showStatusMessage('simpleTransactionStatus', `Successfully sent ${ethValue} ETH to ${formatAddress(destAddress)}!`, 'success');

            } catch (error) {
                console.error('Transaction error:', error);
                showStatusMessage('simpleTransactionStatus', `Transaction failed: ${error.message}`, 'error');
            }
        }

        // Encode function call
        function encodeFunction() {
            try {
                const functionName = document.getElementById('functionName').value;
                const manualCalldata = document.getElementById('manualCalldata').value;

                if (manualCalldata.trim()) {
                    // Use manual calldata
                    document.getElementById('calldataResult').textContent = manualCalldata;
                    document.getElementById('encodedCalldata').style.display = 'block';
                    return;
                }

                if (!functionName) {
                    throw new Error('Please enter a function name');
                }

                // Get parameters from function builder
                const paramInputs = document.querySelectorAll('#functionInputs .input-group');
                const types = [];
                const values = [];

                paramInputs.forEach(input => {
                    const type = input.querySelector('.param-type').value;
                    const value = input.querySelector('.param-value').value;

                    if (value.trim()) {
                        types.push(type);
                        values.push(value);
                    }
                });

                // Create function signature
                const functionSignature = `${functionName}(${types.join(',')})`;

                // Create interface and encode
                const iface = new ethers.Interface([`function ${functionSignature}`]);
                const encodedData = iface.encodeFunctionData(functionName, values);

                document.getElementById('calldataResult').textContent = encodedData;
                document.getElementById('encodedCalldata').style.display = 'block';

                showStatusMessage('contractInteractionStatus', 'Function encoded successfully!', 'success');

            } catch (error) {
                console.error('Encoding error:', error);
                showStatusMessage('contractInteractionStatus', `Encoding failed: ${error.message}`, 'error');
            }
        }

        // Execute contract call (simulated)
        async function executeContractCall() {
            try {
                if (!smartAccountAddress) {
                    throw new Error('Please deploy a smart account first');
                }

                const contractAddress = document.getElementById('contractAddress').value;
                const contractValue = document.getElementById('contractValue').value || '0';
                const calldata = document.getElementById('calldataResult').textContent;

                if (!ethers.isAddress(contractAddress)) {
                    throw new Error('Invalid contract address');
                }

                if (!calldata || calldata === '') {
                    throw new Error('Please encode the function call first');
                }

                showStatusMessage('contractInteractionStatus', 'Executing contract call...', 'info');

                // Simulate transaction delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                showStatusMessage('contractInteractionStatus', `Contract call executed successfully!`, 'success');

            } catch (error) {
                console.error('Contract call error:', error);
                showStatusMessage('contractInteractionStatus', `Contract call failed: ${error.message}`, 'error');
            }
        }

        // Parameter management functions
        function addParameter() {
            const container = document.getElementById('functionInputs');
            const newParam = document.createElement('div');
            newParam.className = 'input-group';
            newParam.innerHTML = `
            <div class="form-group" style="margin: 0; flex: 1;">
                <label>Parameter Type</label>
                <select class="param-type">
                    <option value="address">address</option>
                    <option value="uint256">uint256</option>
                    <option value="string">string</option>
                    <option value="bool">bool</option>
                    <option value="bytes">bytes</option>
                    <option value="uint8">uint8</option>
                    <option value="uint32">uint32</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0; flex: 2;">
                <label>Parameter Value</label>
                <input type="text" class="param-value" placeholder="Enter value...">
            </div>
            <button type="button" class="remove-btn">‚úï</button>
        `;
            container.appendChild(newParam);
            updateRemoveButtons();
        }

        function removeParameter(button) {
            button.closest('.input-group').remove();
            updateRemoveButtons();
        }

        function updateRemoveButtons() {
            const paramInputs = document.querySelectorAll('#functionInputs .input-group');
            paramInputs.forEach((input, index) => {
                const removeBtn = input.querySelector('.remove-btn');
                if (paramInputs.length > 1) {
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }

        // Form validation
        function validateSimpleTransaction() {
            const destAddress = document.getElementById('simpleDestAddress').value;
            const ethValue = document.getElementById('simpleEthValue').value;
            const isValid = ethers.isAddress(destAddress) &&
                ethValue &&
                parseFloat(ethValue) > 0;

            document.getElementById('executeSimpleTransaction').disabled = !isValid;
        }

        function validateContractInteraction() {
            const contractAddress = document.getElementById('contractAddress').value;
            const isValid = ethers.isAddress(contractAddress);
            document.getElementById('executeContractCall').disabled = !isValid;
        }

        // Utility functions
        function showStatusMessage(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type} show`;

            // Hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.classList.remove('show');
                }, 5000);
            }
        }

        function formatAddress(address) {
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (isConnected) {
                statusElement.textContent = 'üü¢ Connected';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'üî¥ Disconnected';
                statusElement.className = 'connection-status disconnected';
            }
        }
    </script>
</body>

</html>